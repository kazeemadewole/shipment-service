<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:; style-src 'self' 'unsafe-inline' https:; connect-src 'self' https:; img-src 'self' data: https: blob:; font-src 'self' https:; media-src 'self' blob:;"
    />
    <title>Battery QC Form - MaxNG</title>

    <!-- Bootstrap CSS for mobile responsiveness -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- Font Awesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <!-- Barcode Scanner - Using HTML5-QRCode library for both barcode and QR code support -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <style>
      body {
        background-color: #f8f9fa;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }

      .qc-header {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        padding: 1rem 0;
        margin-bottom: 2rem;
      }

      .qc-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
      }

      .qc-card-header {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        border-radius: 15px 15px 0 0 !important;
        padding: 1rem 1.5rem;
      }

      .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
      }

      .form-control,
      .form-select {
        border-radius: 8px;
        border: 2px solid #e9ecef;
        padding: 0.75rem;
        transition: border-color 0.3s ease;
      }

      .form-control:focus,
      .form-select:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
      }

      .checkbox-group {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
      }

      .checkbox-item {
        margin-bottom: 0.5rem;
      }

      .btn-primary {
        background: linear-gradient(135deg, #007bff, #0056b3);
        border: none;
        border-radius: 8px;
        padding: 0.75rem 2rem;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
      }

      .btn-success {
        background: linear-gradient(135deg, #28a745, #20c997);
        border: none;
        border-radius: 8px;
        padding: 0.75rem 2rem;
        font-weight: 600;
      }

      .btn-warning {
        background: linear-gradient(135deg, #ffc107, #fd7e14);
        border: none;
        border-radius: 8px;
        padding: 0.75rem 2rem;
        font-weight: 600;
      }

      .telemetry-item {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        border-left: 4px solid #007bff;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .telemetry-value {
        font-weight: 600;
        color: #495057;
      }
      .barcode-scanner {
        max-width: 100%;
        border-radius: 8px;
        margin-bottom: 1rem;
        min-height: 300px;
        background-color: #f8f9fa;
        border: 2px solid #007bff;
        position: relative;
        overflow: hidden;
      }

      /* Specific styling for HTML5QrCode library */
      #qr-scanner video {
        width: 100% !important;
        height: auto !important;
        object-fit: cover;
        border-radius: 6px;
      }

      /* Ensure scanner fills parent container */
      #qr-scanner div {
        width: 100% !important;
      }

      /* Ensure camera permission dialog is visible */
      #qr-scanner canvas {
        position: static !important;
      }

      /* Scanner overlay animation */
      .scanner-animation {
        position: relative;
      }

      .scanner-animation::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background-color: rgba(255, 0, 0, 0.7);
        box-shadow: 0 0 10px 3px rgba(255, 0, 0, 0.5);
        animation: scan 2s linear infinite;
        z-index: 10;
        pointer-events: none;
      }

      @keyframes scan {
        0% {
          top: 0;
        }
        50% {
          top: calc(100% - 3px);
        }
        100% {
          top: 0;
        }
      }

      /* Guide line for barcode scanning */
      .barcode-scanner::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        width: 100%;
        height: 2px;
        background-color: rgba(0, 123, 255, 0.5);
        z-index: 9;
        pointer-events: none;
      }

      /* Rectangle guide for barcode */
      #barcode-guide-rect {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 80%;
        height: 100px;
        transform: translate(-50%, -50%);
        border: 2px dashed rgba(255, 255, 255, 0.6);
        z-index: 9;
        pointer-events: none;
        box-shadow: 0 0 0 2000px rgba(0, 0, 0, 0.3);
      }

      .loading-spinner {
        display: none;
        text-align: center;
        padding: 2rem;
      }

      .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.875rem;
      }

      .status-pending {
        background: #fff3cd;
        color: #856404;
      }

      .status-progress {
        background: #cce7ff;
        color: #004085;
      }

      .status-completed {
        background: #d1eddd;
        color: #155724;
      }

      .status-failed {
        background: #f8d7da;
        color: #721c24;
      }

      .image-upload-section {
        background: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
        text-align: center;
        transition: all 0.3s ease;
      }

      .image-upload-section:hover {
        border-color: #007bff;
        background: #e7f3ff;
      }

      .image-upload-section.has-image {
        border-color: #28a745;
        background: #d4edda;
      }

      .image-preview {
        max-width: 200px;
        max-height: 200px;
        border-radius: 8px;
        margin: 0.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .upload-icon {
        font-size: 2rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
      }

      .file-input-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
      }

      .file-input-wrapper input[type='file'] {
        position: absolute;
        left: -9999px;
      }

      .custom-file-btn {
        background: #007bff;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.3s ease;
      }

      .custom-file-btn:hover {
        background: #0056b3;
      }

      /* Required field styling */
      .text-danger {
        font-weight: bold;
      }

      .image-upload-section.required {
        border-color: #dc3545;
      }

      .image-upload-section.required:not(.has-image) {
        border-style: solid;
        border-width: 2px;
        background: #f8d7da;
      }

      .image-upload-section.required:not(.has-image):hover {
        border-color: #c82333;
        background: #f5c6cb;
      }

      @media (max-width: 768px) {
        .container {
          padding: 0 1rem;
        }

        .qc-card {
          margin-bottom: 1rem;
        }

        .btn {
          width: 100%;
          margin-bottom: 0.5rem;
        }

        .telemetry-item {
          flex-direction: column;
          align-items: flex-start;
        }

        .telemetry-item .form-check {
          margin-top: 0.5rem;
        }

        .telemetry-fetch-btn {
          margin-top: 1rem;
        }

        /* Loading and success states */
        .btn:disabled {
          opacity: 0.7;
          cursor: not-allowed;
        }

        .toast-notification {
          animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
          from {
            transform: translateX(100%);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }

        .spinner-border-sm {
          width: 1rem;
          height: 1rem;
        }
      }
    </style>
  </head>
  <body>
    <!-- Navigation -->
    <div class="container-fluid" style="background-color: #f8f9fa; border-bottom: 1px solid #dee2e6">
      <div class="container">
        <div class="py-2">
          <a href="/" style="color: #007bff; text-decoration: none; font-weight: 600">
            <i class="fas fa-arrow-left me-1"></i> Back to Tools Directory
          </a>
          <span class="mx-2">|</span>
          <a href="/qc-dashboard" style="color: #007bff; text-decoration: none; font-weight: 600">
            <i class="fas fa-tachometer-alt me-1"></i> QC Dashboard
          </a>
        </div>
      </div>
    </div>

    <!-- Header -->
    <header class="qc-header">
      <div class="container">
        <div class="row align-items-center">
          <div class="col">
            <h1 class="h3 mb-0">
              <i class="fas fa-clipboard-check me-2"></i>
              Battery QC Form
            </h1>
            <p class="mb-0 opacity-75">Quality Control Inspection for EV Batteries</p>
          </div>
        </div>
      </div>
    </header>

    <div class="container">
      <!-- Required Fields Notice -->
      <div class="alert alert-info mb-3">
        <i class="fas fa-info-circle me-2"></i>
        <strong>Note:</strong> Fields marked with <span class="text-danger">*</span> are required. Please ensure both
        battery and terminals images are uploaded before submitting the form.
      </div>

      <form id="qcForm">
        <!-- Battery Information Card -->
        <div class="card qc-card">
          <div class="card-header qc-card-header">
            <h5 class="mb-0">
              <i class="fas fa-battery-half me-2"></i>
              Battery Information
            </h5>
          </div>
          <div class="card-body">
            <!-- Barcode Scanner -->
            <div class="mb-4">
              <label class="form-label">
                <i class="fas fa-barcode me-1"></i>
                Scan Barcode to Extract Serial Number
              </label>
              <div id="qr-scanner" class="barcode-scanner d-none">
                <!-- Barcode guide rectangle will be added here -->
                <div id="barcode-guide-rect"></div>
              </div>
              <div id="scanner-status" class="text-center mt-2 d-none">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Scanning...</span>
                </div>
                <p class="mb-0 mt-1">Scanning for barcodes...</p>
              </div>
              <button type="button" class="btn btn-primary btn-sm" id="startScanner">
                <i class="fas fa-camera me-1"></i>
                Start Barcode Scanner
              </button>
              <button type="button" class="btn btn-secondary btn-sm d-none" id="stopScanner">
                <i class="fas fa-stop me-1"></i>
                Stop Scanner
              </button>
            </div>

            <div class="mb-3">
              <label for="batterySerial" class="form-label">Battery Serial Number *</label>
              <input type="text" class="form-control" id="batterySerial" name="battery_serial" required />
            </div>

            <div class="mb-3">
              <label for="officerName" class="form-label">QC Officer Name *</label>
              <input type="text" class="form-control" id="officerName" name="officer_name" required />
            </div>
          </div>
        </div>

        <!-- Physical Inspection Card -->
        <div class="card qc-card">
          <div class="card-header qc-card-header">
            <h5 class="mb-0">
              <i class="fas fa-search me-2"></i>
              Physical Inspection
            </h5>
          </div>
          <div class="card-body">
            <!-- Visual Confirmation - Battery -->
            <div class="mb-4">
              <h6 class="fw-bold mb-3">Visual Confirmation - Whole Battery</h6>
              <div class="checkbox-group">
                <div class="checkbox-item">
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="batteryCracks"
                      name="physical_inspection.visual_confirmation_battery.cracks"
                    />
                    <label class="form-check-label" for="batteryCracks">
                      <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                      Cracks Detected
                    </label>
                  </div>
                </div>
                <div class="checkbox-item">
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="batteryRust"
                      name="physical_inspection.visual_confirmation_battery.rust"
                    />
                    <label class="form-check-label" for="batteryRust">
                      <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                      Rust Detected
                    </label>
                  </div>
                </div>
                <div class="checkbox-item">
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="batteryLeaks"
                      name="physical_inspection.visual_confirmation_battery.leaks"
                    />
                    <label class="form-check-label" for="batteryLeaks">
                      <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                      Leaks Detected
                    </label>
                  </div>
                </div>
              </div>

              <!-- Battery Image Upload -->
              <div class="image-upload-section required" id="batteryImageSection">
                <div class="upload-icon">
                  <i class="fas fa-camera"></i>
                </div>
                <h6 class="mb-2">Upload Battery Image <span class="text-danger">*</span></h6>
                <p class="text-muted mb-3">Take a photo of the whole battery for documentation</p>
                <div class="file-input-wrapper">
                  <input type="file" id="batteryImageInput" accept="image/*" capture="environment" />
                  <label for="batteryImageInput" class="custom-file-btn">
                    <i class="fas fa-upload me-1"></i>
                    Choose Image
                  </label>
                </div>
                <div id="batteryImagePreview" class="mt-3"></div>
              </div>
            </div>

            <!-- Visual Confirmation - Terminals -->
            <div class="mb-4">
              <h6 class="fw-bold mb-3">Visual Confirmation - Terminals</h6>
              <div class="checkbox-group">
                <div class="checkbox-item">
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="terminalCracks"
                      name="physical_inspection.visual_confirmation_terminals.cracks"
                    />
                    <label class="form-check-label" for="terminalCracks">
                      <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                      Cracks Detected
                    </label>
                  </div>
                </div>
                <div class="checkbox-item">
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="terminalRust"
                      name="physical_inspection.visual_confirmation_terminals.rust"
                    />
                    <label class="form-check-label" for="terminalRust">
                      <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                      Rust Detected
                    </label>
                  </div>
                </div>
                <div class="checkbox-item">
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="terminalLeaks"
                      name="physical_inspection.visual_confirmation_terminals.leaks"
                    />
                    <label class="form-check-label" for="terminalLeaks">
                      <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                      Leaks Detected
                    </label>
                  </div>
                </div>
              </div>

              <!-- Terminals Image Upload -->
              <div class="image-upload-section required" id="terminalsImageSection">
                <div class="upload-icon">
                  <i class="fas fa-camera"></i>
                </div>
                <h6 class="mb-2">Upload Terminals Image <span class="text-danger">*</span></h6>
                <p class="text-muted mb-3">Take a photo of the battery terminals for documentation</p>
                <div class="file-input-wrapper">
                  <input type="file" id="terminalsImageInput" accept="image/*" capture="environment" />
                  <label for="terminalsImageInput" class="custom-file-btn">
                    <i class="fas fa-upload me-1"></i>
                    Choose Image
                  </label>
                </div>
                <div id="terminalsImagePreview" class="mt-3"></div>
              </div>
            </div>

            <!-- Weight and Compatibility -->
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="weightConfirmation" class="form-label">
                    <i class="fas fa-weight me-1"></i>
                    Weight Confirmation (kg) *
                  </label>
                  <input
                    type="number"
                    step="0.1"
                    class="form-control"
                    id="weightConfirmation"
                    name="physical_inspection.weight_confirmation"
                    required
                  />
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3 d-flex align-items-end">
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="jktCompatibility"
                      name="physical_inspection.connector_jkt_compatibility"
                    />
                    <label class="form-check-label" for="jktCompatibility">
                      <i class="fas fa-plug me-1"></i>
                      Charger Compatibility Confirmed
                    </label>
                  </div>
                </div>
              </div>
            </div>

            <div class="mb-3">
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="serialMatch"
                  name="physical_inspection.serial_match_waybill"
                />
                <label class="form-check-label" for="serialMatch">
                  <i class="fas fa-check-circle me-1"></i>
                  Serial Number Matches Waybill Asset Register
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Telemetry Testing Card -->
        <div class="card qc-card">
          <div class="card-header qc-card-header">
            <h5 class="mb-0">
              <i class="fas fa-chart-line me-2"></i>
              Telemetry Testing
            </h5>
          </div>
          <div class="card-body">
            <div class="row mb-3">
              <div class="col-md-8">
                <label for="testVehiclePlate" class="form-label">
                  <i class="fas fa-car me-1"></i>
                  Test Vehicle Plate Number *
                </label>
                <input
                  type="text"
                  class="form-control"
                  id="testVehiclePlate"
                  name="test_vehicle_plate_number"
                  style="text-transform: uppercase"
                  required
                />
              </div>
              <div class="col-md-4 d-flex align-items-end telemetry-fetch-btn">
                <button type="button" class="btn btn-warning w-100" id="fetchTelemetry">
                  <i class="fas fa-download me-1"></i>
                  Fetch IoT Data
                </button>
              </div>
            </div>

            <div class="loading-spinner" id="loadingSpinner">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Fetching telemetry data...</p>
            </div>

            <div id="telemetryData" class="d-none">
              <h6 class="fw-bold mb-3">Telemetry Data - Confirm Values</h6>

              <div class="telemetry-item">
                <div>
                  <strong>Voltage:</strong>
                  <span class="telemetry-value" id="voltageValue">--</span>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="voltageConfirmed"
                    name="telemetry_data.voltage.confirmed"
                  />
                  <label class="form-check-label" for="voltageConfirmed">Confirmed</label>
                </div>
              </div>

              <div class="telemetry-item">
                <div>
                  <strong>Temperature:</strong>
                  <span class="telemetry-value" id="temperatureValue">--</span>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="temperatureConfirmed"
                    name="telemetry_data.temperature.confirmed"
                  />
                  <label class="form-check-label" for="temperatureConfirmed">Confirmed</label>
                </div>
              </div>

              <div class="telemetry-item">
                <div style="flex-grow: 1">
                  <strong>Individual Cell Voltage:</strong>
                  <div
                    class="telemetry-value mt-2"
                    id="cellVoltageValue"
                    style="max-height: 150px; overflow-y: auto; font-size: 0.85rem; line-height: 1.3"
                  >
                    --
                  </div>
                </div>
                <div class="form-check ms-3">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="cellVoltageConfirmed"
                    name="telemetry_data.individual_cell_voltage.confirmed"
                  />
                  <label class="form-check-label" for="cellVoltageConfirmed">Confirmed</label>
                </div>
              </div>

              <div class="telemetry-item">
                <div>
                  <strong>Differential Voltage:</strong>
                  <span class="telemetry-value" id="differentialVoltageValue">--</span>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="differentialVoltageConfirmed"
                    name="telemetry_data.differential_voltage.confirmed"
                  />
                  <label class="form-check-label" for="differentialVoltageConfirmed">Confirmed</label>
                </div>
              </div>

              <div class="telemetry-item">
                <div>
                  <strong>State of Charge (SOC):</strong>
                  <span class="telemetry-value" id="socValue">--</span>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="socConfirmed"
                    name="telemetry_data.soc.confirmed"
                  />
                  <label class="form-check-label" for="socConfirmed">Confirmed</label>
                </div>
              </div>

              <div class="telemetry-item">
                <div>
                  <strong>Cycle Count:</strong>
                  <span class="telemetry-value" id="cycleCountValue">--</span>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="cycleCountConfirmed"
                    name="telemetry_data.cycle_count.confirmed"
                  />
                  <label class="form-check-label" for="cycleCountConfirmed">Confirmed</label>
                </div>
              </div>

              <div class="telemetry-item">
                <div>
                  <strong>Location (Lat, Long):</strong>
                  <span class="telemetry-value" id="locationValue">--</span>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="locationConfirmed"
                    name="telemetry_data.lat_long.confirmed"
                  />
                  <label class="form-check-label" for="locationConfirmed">Confirmed</label>
                </div>
              </div>

              <div class="telemetry-item">
                <div>
                  <strong>Last Updated:</strong>
                  <span class="telemetry-value" id="lastUpdatedValue">--</span>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="lastUpdatedConfirmed"
                    name="telemetry_data.last_updated.confirmed"
                  />
                  <label class="form-check-label" for="lastUpdatedConfirmed">Confirmed</label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Notes and Actions Card -->
        <div class="card qc-card">
          <div class="card-header qc-card-header">
            <h5 class="mb-0">
              <i class="fas fa-sticky-note me-2"></i>
              Additional Notes & Actions
            </h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label for="notes" class="form-label">Additional Notes</label>
              <textarea
                class="form-control"
                id="notes"
                name="notes"
                rows="4"
                placeholder="Enter any additional observations or notes..."
              ></textarea>
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
              <button type="submit" class="btn btn-success" id="submitForm">
                <i class="fas fa-check-circle me-1"></i>
                Complete QC Inspection
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom JavaScript -->
    <script>
      // Barcode scanner variables for jsQR implementation

      // Initialize Barcode Scanner
      document.getElementById('startScanner').addEventListener('click', function () {
        startQRScanner();
      });

      document.getElementById('stopScanner').addEventListener('click', function () {
        stopQRScanner();
      });

      let html5QrcodeScanner = null;
      let scanningActive = false;

      function startQRScanner() {
        // Check if HTML5-QRCode library is available
        if (typeof Html5Qrcode === 'undefined') {
          // Try loading the library if not available
          const script = document.createElement('script');
          script.src = 'https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js';
          script.onload = function () {
            console.log('HTML5-QRCode library loaded successfully');
            initBarcodeScanner();
          };
          script.onerror = function () {
            console.error('Failed to load HTML5-QRCode library');
            showToast(
              'Barcode scanner library could not be loaded. Please refresh the page or enter manually.',
              'warning',
            );
          };
          document.head.appendChild(script);
          return;
        }

        console.log('Starting barcode scanner with HTML5-QRCode...');
        initBarcodeScanner();
      }
      function initBarcodeScanner() {
        const scannerElement = document.getElementById('qr-scanner');

        // Make scanner div visible
        scannerElement.classList.remove('d-none');
        scannerElement.innerHTML = ''; // Clear any previous content

        // Update UI elements
        document.getElementById('startScanner').classList.add('d-none');
        document.getElementById('stopScanner').classList.remove('d-none');
        document.getElementById('scanner-status').classList.remove('d-none');

        // Scanner configuration specifically optimized for Mac camera and barcode scanning
        const config = {
          fps: 15, // Higher frame rate for better detection
          qrbox: undefined, // Don't limit scan area for Mac camera
          aspectRatio: undefined, // Let the library determine the aspect ratio
          formatsToSupport: [
            // Formats specifically for barcode scanning, prioritize common formats for better performance
            Html5QrcodeSupportedFormats.CODE_128,
            Html5QrcodeSupportedFormats.EAN_13,
            Html5QrcodeSupportedFormats.CODE_39,
            Html5QrcodeSupportedFormats.CODE_93,
            Html5QrcodeSupportedFormats.EAN_8,
            Html5QrcodeSupportedFormats.UPC_A,
            Html5QrcodeSupportedFormats.UPC_E,
            Html5QrcodeSupportedFormats.CODABAR,
            Html5QrcodeSupportedFormats.ITF,
            Html5QrcodeSupportedFormats.QR_CODE, // Include QR code as well, just in case
          ],
          experimentalFeatures: {
            useBarCodeDetectorIfSupported: false, // Disable experimental feature which might be causing issues
          },
          videoConstraints: {
            width: { ideal: 1280, min: 640 },
            height: { ideal: 720, min: 480 },
            facingMode: { ideal: 'environment' },
          },
        };

        // Create the HTML5 QR code scanner instance
        html5QrcodeScanner = new Html5Qrcode('qr-scanner');
        scanningActive = true;

        // Define callbacks for barcode detection and error handling
        const barcodeDetectionCallback = (decodedText) => {
          console.log('Barcode detected:', decodedText);

          // Clean the barcode data
          const cleanedData = decodedText.trim();

          if (cleanedData) {
            const batterySerialField = document.getElementById('batterySerial');

            if (batterySerialField) {
              // Set the value
              batterySerialField.value = cleanedData;

              // Trigger events
              batterySerialField.focus();
              batterySerialField.dispatchEvent(new Event('input', { bubbles: true }));
              batterySerialField.dispatchEvent(new Event('change', { bubbles: true }));

              // Visual confirmation
              batterySerialField.style.backgroundColor = '#d4edda';
              setTimeout(() => {
                batterySerialField.style.backgroundColor = '';
              }, 1000);

              showToast(`Barcode scanned: ${cleanedData}`, 'success');

              // Stop scanning
              stopQRScanner();
            }
          }
        };

        const errorCallback = (errorMessage) => {
          // Handle error, but don't show errors to the user during normal scanning
          if (Math.random() < 0.001) {
            // Log very occasionally
            console.log(`QR Code scanning in progress...`);
          }
        };

        // Debug logging for Mac camera setup
        console.log('Starting camera detection for Mac...');

        // First try direct scanner without camera selection for Mac
        html5QrcodeScanner
          .start(
            { facingMode: 'environment' }, // Use environment facing mode first
            config,
            barcodeDetectionCallback,
            errorCallback,
          )
          .catch((err) => {
            console.log('Direct start failed, trying to get specific cameras:', err);

            // Fall back to camera enumeration if direct start fails
            Html5Qrcode.getCameras()
              .then((devices) => {
                console.log('Available cameras:', devices);

                if (devices && devices.length) {
                  // On Mac, prefer the first camera (usually the built-in camera)
                  let selectedCameraId = devices[0].id;

                  // Log all available cameras to help with debugging
                  devices.forEach((camera, index) => {
                    console.log(`Camera ${index}: ${camera.id} - ${camera.label}`);
                  });

                  // On Mac, the built-in camera is usually the first one
                  // but we'll still try to find a back camera if available
                  const backCamera = devices.find(
                    (camera) =>
                      camera.label.toLowerCase().includes('back') ||
                      camera.label.toLowerCase().includes('rear') ||
                      camera.label.toLowerCase().includes('environment'),
                  );

                  if (backCamera) {
                    selectedCameraId = backCamera.id;
                    console.log('Found back camera:', backCamera.label);
                  }

                  console.log('Starting scanner with camera ID:', selectedCameraId);

                  // Start scanning with Mac-specific optimizations
                  html5QrcodeScanner
                    .start(selectedCameraId, config, barcodeDetectionCallback, errorCallback)
                    .then(() => {
                      console.log('Scanner started successfully');
                      showToast('Camera started. Point camera at barcode.', 'info');

                      // Add scanning overlay
                      scannerElement.classList.add('scanner-animation');

                      // Add styling to the scanner view for better UX
                      const scannerContainer = document.getElementById('qr-scanner');
                      if (scannerContainer) {
                        // Find the video element created by the library
                        const videoElement = scannerContainer.querySelector('video');
                        if (videoElement) {
                          videoElement.style.width = '100%';
                          videoElement.style.maxHeight = '300px';
                          videoElement.style.borderRadius = '8px';
                          videoElement.style.border = '2px solid #007bff';
                        }
                      }
                    })
                    .catch((err) => {
                      console.error('Error starting scanner:', err);
                      showToast('Could not start camera. Please check permissions and try again.', 'error');
                      stopQRScanner();
                    });
                } else {
                  console.error('No cameras found');
                  showToast('No cameras found on this device.', 'error');
                  stopQRScanner();
                }
              })
              .catch((err) => {
                console.error('Error getting cameras:', err);
                showToast('Could not access camera. Please check permissions.', 'error');
                stopQRScanner();
              });
          });
      }
      function stopQRScanner() {
        scanningActive = false;

        // Stop HTML5QRCode scanner if it's running
        if (html5QrcodeScanner) {
          try {
            html5QrcodeScanner
              .stop()
              .then(() => {
                console.log('HTML5QRCode scanner stopped successfully');
              })
              .catch((err) => {
                console.error('Error stopping scanner:', err);
              })
              .finally(() => {
                html5QrcodeScanner = null;
              });
          } catch (e) {
            console.error('Error stopping HTML5QRCode scanner:', e);
          }
        }

        // Clear scanner content
        const scannerElement = document.getElementById('qr-scanner');
        if (scannerElement) {
          scannerElement.innerHTML = '';
          scannerElement.classList.add('d-none'); // Hide the scanner div
        }

        // Update UI elements
        document.getElementById('startScanner').classList.remove('d-none');
        document.getElementById('stopScanner').classList.add('d-none');
        document.getElementById('scanner-status').classList.add('d-none');
        document.getElementById('qr-scanner').classList.remove('scanner-animation');

        console.log('Barcode scanner stopped');
      }

      // Fetch Telemetry Data
      document.getElementById('fetchTelemetry').addEventListener('click', function () {
        const plateNumber = document.getElementById('testVehiclePlate').value;

        if (!plateNumber) {
          showToast('Please enter a vehicle plate number', 'warning');
          return;
        }

        fetchTelemetryData(plateNumber);
      });

      async function fetchTelemetryData(plateNumber) {
        const loadingSpinner = document.getElementById('loadingSpinner');
        const telemetryData = document.getElementById('telemetryData');

        loadingSpinner.style.display = 'block';
        telemetryData.classList.add('d-none');

        try {
          const response = await fetch('/qc-forms/fetch-telemetry', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ plate_number: plateNumber }),
          });

          // Parse response JSON first
          let result;
          try {
            result = await response.json();
          } catch (parseError) {
            throw new Error(`Server error: ${response.status} ${response.statusText}`);
          }

          // Check if the API returned success: false
          if (!result.success) {
            // Extract error message from API response format
            const errorMessage =
              result.message || `Error ${result.statusCode || response.status}: Failed to fetch telemetry data`;
            throw new Error(errorMessage);
          }

          // Success case
          populateTelemetryData(result.data);
          telemetryData.classList.remove('d-none');
          showToast('Telemetry data fetched successfully!', 'success');
        } catch (error) {
          console.error('Error fetching telemetry data:', error);
          // Show the actual error message from the API or a fallback message
          const errorMessage =
            error.message || 'Error fetching telemetry data. Please check your connection and try again.';
          showToast(errorMessage, 'error');
        } finally {
          loadingSpinner.style.display = 'none';
        }
      }

      function formatCellVoltageDisplay(cellVoltageData) {
        if (!cellVoltageData || typeof cellVoltageData !== 'object') {
          return '<span class="text-muted">No cell voltage data available</span>';
        }

        let formattedHtml =
          '<div class="cell-voltage-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; margin-top: 8px;">';

        // Display individual cells
        for (let i = 1; i <= 20; i++) {
          const cellKey = `cell_${i}`;
          if (cellVoltageData[cellKey] !== undefined) {
            const voltage = parseFloat(cellVoltageData[cellKey]);
            const colorClass = voltage > 0 ? 'text-success' : 'text-muted';
            formattedHtml += `
              <div class="cell-item" style="background: #f8f9fa; padding: 4px 8px; border-radius: 4px; text-align: center; font-size: 0.75rem;">
                <div style="font-weight: 500;">Cell ${i}</div>
                <div class="${colorClass}">${voltage.toFixed(2)}V</div>
              </div>
            `;
          }
        }

        formattedHtml += '</div>';

        // Display summary info if available
        if (cellVoltageData.avg_voltage !== undefined || cellVoltageData.max_voltage !== undefined) {
          formattedHtml +=
            '<div class="voltage-summary mt-3" style="background: #e3f2fd; padding: 8px; border-radius: 4px; font-size: 0.8rem;">';
          if (cellVoltageData.avg_voltage !== undefined) {
            formattedHtml += `<strong>Avg:</strong> ${parseFloat(cellVoltageData.avg_voltage).toFixed(2)}V &nbsp; `;
          }
          if (cellVoltageData.max_voltage !== undefined) {
            formattedHtml += `<strong>Max:</strong> ${parseFloat(cellVoltageData.max_voltage).toFixed(2)}V &nbsp; `;
          }
          if (cellVoltageData.min_voltage !== undefined) {
            formattedHtml += `<strong>Min:</strong> ${parseFloat(cellVoltageData.min_voltage).toFixed(2)}V &nbsp; `;
          }
          if (cellVoltageData.voltage_difference !== undefined) {
            formattedHtml += `<strong>Diff:</strong> ${parseFloat(cellVoltageData.voltage_difference).toFixed(3)}V`;
          }
          formattedHtml += '</div>';
        }

        return formattedHtml;
      }

      function populateTelemetryData(data) {
        document.getElementById('voltageValue').textContent = data.voltage.value + ' V';
        document.getElementById('temperatureValue').textContent = data.temperature.value + ' Â°C';

        // Format cell voltage data nicely
        const cellVoltageElement = document.getElementById('cellVoltageValue');
        cellVoltageElement.innerHTML = formatCellVoltageDisplay(data.individual_cell_voltage.value);
        // Store the raw data as a data attribute for form submission
        cellVoltageElement.setAttribute('data-raw-value', JSON.stringify(data.individual_cell_voltage.value));

        document.getElementById('differentialVoltageValue').textContent = data.differential_voltage.value + ' V';
        document.getElementById('socValue').textContent = data.soc.value + ' %';
        document.getElementById('cycleCountValue').textContent = data.cycle_count.value;
        document.getElementById('locationValue').textContent = data.lat_long.value;

        // Format and display last updated timestamp
        const lastUpdatedElement = document.getElementById('lastUpdatedValue');
        if (data.last_updated && data.last_updated.value) {
          const lastUpdated = new Date(data.last_updated.value);
          lastUpdatedElement.textContent = lastUpdated.toLocaleString();
          // Store the ISO string for form submission
          lastUpdatedElement.setAttribute('data-iso-value', data.last_updated.value);
        } else {
          lastUpdatedElement.textContent = 'Unknown';
          lastUpdatedElement.removeAttribute('data-iso-value');
        }
      }

      // Form Submission
      document.getElementById('qcForm').addEventListener('submit', function (e) {
        e.preventDefault();
        submitQCForm();
      });

      async function submitQCForm() {
        // First, validate that required images are uploaded
        const batteryImageInput = document.getElementById('batteryImageInput');
        const terminalsImageInput = document.getElementById('terminalsImageInput');

        const batteryImageUrl = batteryImageInput.getAttribute('data-uploaded-url');
        const terminalsImageUrl = terminalsImageInput.getAttribute('data-uploaded-url');

        // Check if both images are uploaded
        if (!batteryImageUrl) {
          showToast('Please upload a battery image before submitting the form', 'error');
          document.getElementById('batteryImageSection').scrollIntoView({ behavior: 'smooth', block: 'center' });
          return;
        }

        if (!terminalsImageUrl) {
          showToast('Please upload a terminals image before submitting the form', 'error');
          document.getElementById('terminalsImageSection').scrollIntoView({ behavior: 'smooth', block: 'center' });
          return;
        }

        const formData = collectFormData();

        // Collect image data
        const imageData = await collectImageData();

        // Merge form data with image data
        const completeFormData = { ...formData, ...imageData };

        // Get submit button for loading state
        const submitBtn = document.getElementById('submitForm');

        // Store original button content
        const originalContent = submitBtn.innerHTML;

        // Set loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = `
          <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
          Submitting...
        `;

        try {
          console.log('Submitting QC Form:', completeFormData); // Debug log
          const response = await fetch('/qc-forms', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(completeFormData),
          });

          console.log('Response Status:', response.status); // Debug log
          console.log('Response OK:', response.ok); // Debug log

          // Parse response JSON first
          let result;
          try {
            result = await response.json();
            console.log('API Response:', result); // Debug log
          } catch (parseError) {
            console.error('JSON Parse Error:', parseError); // Debug log
            const errorMessage = `Server error: ${response.status} ${response.statusText}`;
            console.log('Parse Error - showing toast:', errorMessage); // Debug log
            showToast(errorMessage, 'error');
            throw new Error(errorMessage);
          }

          // Check if the request was successful
          if (!response.ok || !result.success) {
            // Extract error message from API response format
            const errorMessage =
              result.message || `Error ${result.statusCode || response.status}: Failed to submit QC form`;
            console.log('API Error - showing toast:', errorMessage); // Debug log
            showToast(errorMessage, 'error');
            throw new Error(errorMessage);
          }

          // Success case
          const successMessage = 'QC Form submitted successfully!';
          showToast(successMessage, 'success');

          // Show success message with reset option
          showToast(
            'QC Form submitted successfully! Form will be reset in 3 seconds for the next inspection...',
            'success',
          );

          // Reset form after successful completion
          setTimeout(() => {
            resetForm();
            showToast('Form has been reset for the next inspection', 'info');
          }, 3000);
        } catch (error) {
          console.error('Error submitting QC form:', error);
          console.log('Error message to show:', error.message); // Debug log

          // Show the actual error message from the API or a fallback message
          const errorMessage = error.message || 'Error submitting QC form. Please check your connection and try again.';
          console.log('Final error message for toast:', errorMessage); // Debug log

          // Ensure the toast is shown
          try {
            showToast(errorMessage, 'error');
            console.log('Toast should be visible now'); // Debug log
          } catch (toastError) {
            console.error('Error showing toast:', toastError);
            // Fallback: use browser alert if toast fails
            alert('Error: ' + errorMessage);
          }
        } finally {
          // Restore button state
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalContent;
        }
      }

      // Helper function to safely get last updated value
      function getSafeLastUpdatedValue() {
        const lastUpdatedElement = document.getElementById('lastUpdatedValue');

        // First try to get the stored ISO value
        const isoValue = lastUpdatedElement.getAttribute('data-iso-value');
        if (isoValue) {
          return isoValue;
        }

        // If no stored ISO value, check the text content
        const textContent = lastUpdatedElement.textContent;
        if (textContent === 'Unknown' || textContent === '--') {
          return new Date().toISOString();
        }

        // Try to parse the displayed text as a date
        try {
          const parsedDate = new Date(textContent);
          if (!isNaN(parsedDate.getTime())) {
            return parsedDate.toISOString();
          }
        } catch (error) {
          console.warn('Failed to parse last updated date:', textContent);
        }

        // Fallback to current date
        return new Date().toISOString();
      }

      function collectFormData() {
        const formData = {
          battery_serial: document.getElementById('batterySerial').value,
          officer_name: document.getElementById('officerName').value,
          test_vehicle_plate_number: document.getElementById('testVehiclePlate').value,
          physical_inspection: {
            visual_confirmation_battery: {
              cracks: document.getElementById('batteryCracks').checked,
              rust: document.getElementById('batteryRust').checked,
              leaks: document.getElementById('batteryLeaks').checked,
            },
            visual_confirmation_terminals: {
              cracks: document.getElementById('terminalCracks').checked,
              rust: document.getElementById('terminalRust').checked,
              leaks: document.getElementById('terminalLeaks').checked,
            },
            weight_confirmation: parseFloat(document.getElementById('weightConfirmation').value) || 0,
            connector_jkt_compatibility: document.getElementById('jktCompatibility').checked,
            serial_match_waybill: document.getElementById('serialMatch').checked,
          },
          notes: document.getElementById('notes').value,
        };

        // Add telemetry data if available
        if (!document.getElementById('telemetryData').classList.contains('d-none')) {
          formData.telemetry_data = {
            voltage: {
              value: document.getElementById('voltageValue').textContent.replace(' V', ''),
              confirmed: document.getElementById('voltageConfirmed').checked,
            },
            temperature: {
              value: document.getElementById('temperatureValue').textContent.replace(' Â°C', ''),
              confirmed: document.getElementById('temperatureConfirmed').checked,
            },
            individual_cell_voltage: {
              value: JSON.parse(document.getElementById('cellVoltageValue').getAttribute('data-raw-value') || '{}'),
              confirmed: document.getElementById('cellVoltageConfirmed').checked,
            },
            differential_voltage: {
              value: document.getElementById('differentialVoltageValue').textContent.replace(' V', ''),
              confirmed: document.getElementById('differentialVoltageConfirmed').checked,
            },
            soc: {
              value: document.getElementById('socValue').textContent.replace(' %', ''),
              confirmed: document.getElementById('socConfirmed').checked,
            },
            cycle_count: {
              value: document.getElementById('cycleCountValue').textContent,
              confirmed: document.getElementById('cycleCountConfirmed').checked,
            },
            lat_long: {
              value: document.getElementById('locationValue').textContent,
              confirmed: document.getElementById('locationConfirmed').checked,
            },
            last_updated: {
              value: getSafeLastUpdatedValue(),
              confirmed: document.getElementById('lastUpdatedConfirmed').checked,
            },
          };
        }

        return formData;
      }

      // Function to collect image data as base64
      function collectImageData() {
        const batteryImageInput = document.getElementById('batteryImageInput');
        const terminalsImageInput = document.getElementById('terminalsImageInput');
        const imageData = {};

        // Get uploaded URLs from data attributes
        const batteryImageUrl = batteryImageInput.getAttribute('data-uploaded-url');
        const terminalsImageUrl = terminalsImageInput.getAttribute('data-uploaded-url');

        if (batteryImageUrl) {
          imageData.battery_image = batteryImageUrl;
        }

        if (terminalsImageUrl) {
          imageData.terminals_image = terminalsImageUrl;
        }

        return Promise.resolve(imageData);
      }

      function showToast(message, type = 'info') {
        // Create toast element with improved styling
        const toast = document.createElement('div');
        const iconMap = {
          success: 'fas fa-check-circle',
          error: 'fas fa-exclamation-circle',
          warning: 'fas fa-exclamation-triangle',
          info: 'fas fa-info-circle',
        };

        const alertClass =
          type === 'error' ? 'danger' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';

        toast.className = `position-fixed top-0 end-0 m-3 alert alert-${alertClass} alert-dismissible fade show toast-notification`;
        toast.style.zIndex = '9999';
        toast.style.minWidth = '300px';
        toast.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
        toast.innerHTML = `
          <div class="d-flex align-items-center">
            <i class="${iconMap[type] || iconMap.info} me-2"></i>
            <span>${message}</span>
            <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
          </div>
        `;

        document.body.appendChild(toast);

        // Auto remove after 5 seconds (8 seconds for success messages)
        const timeout = type === 'success' ? 8000 : 5000;
        setTimeout(() => {
          if (toast.parentNode) {
            toast.classList.add('fade');
            setTimeout(() => {
              if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
              }
            }, 150);
          }
        }, timeout);
      }

      // Auto-populate when serial number is entered
      document.getElementById('batterySerial').addEventListener('blur', async function () {
        const serialNumber = this.value;
        if (serialNumber) {
          try {
            // You can add an API call here to fetch battery details by serial number
            await new Promise((resolve) => setTimeout(resolve, 500));
          } catch (error) {
            console.error('Error fetching battery details:', error);
          }
        }
      });

      // Image upload handling
      function setupImageUpload(inputId, previewId, sectionId) {
        const input = document.getElementById(inputId);
        const preview = document.getElementById(previewId);
        const section = document.getElementById(sectionId);

        input.addEventListener('change', async function (e) {
          const file = e.target.files[0];
          if (file) {
            // Check file size (limit to 5MB)
            if (file.size > 5 * 1024 * 1024) {
              showToast('Image size must be less than 5MB', 'error');
              return;
            }

            // Check file type
            if (!file.type.startsWith('image/')) {
              showToast('Please select a valid image file', 'error');
              return;
            }

            // Show loading state
            preview.innerHTML = `
              <div class="d-flex flex-column align-items-center">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Uploading...</span>
                </div>
                <small class="text-muted mt-2">Uploading image...</small>
              </div>
            `;
            section.classList.add('has-image');

            try {
              // Upload image to AWS
              const imageUrl = await uploadImageToAWS(file);

              // Store the URL in a data attribute for later retrieval
              input.setAttribute('data-uploaded-url', imageUrl);

              // Show preview with uploaded image
              preview.innerHTML = `
                <div class="d-flex flex-column align-items-center">
                  <img src="${imageUrl}" alt="Preview" class="image-preview">
                  <button type="button" class="btn btn-sm btn-outline-danger mt-2 remove-image-btn" data-input-id="${inputId}" data-preview-id="${previewId}" data-section-id="${sectionId}">
                    <i class="fas fa-trash me-1"></i>
                    Remove Image
                  </button>
                  <small class="text-success mt-1">
                    <i class="fas fa-check-circle me-1"></i>
                    Uploaded successfully
                  </small>
                </div>
              `;
              section.classList.add('has-image');

              // Add event listener to the remove button
              const removeBtn = preview.querySelector('.remove-image-btn');
              removeBtn.addEventListener('click', function () {
                removeImage(inputId, previewId, sectionId);
              });

              showToast('Image uploaded successfully', 'success');
            } catch (error) {
              console.error('Error uploading image:', error);

              // Show more specific error message based on error type
              let errorMessage = 'Failed to upload image. Please try again.';
              if (error.message.includes('Upload failed:')) {
                errorMessage = `Upload failed: ${error.message.split('Upload failed:')[1]}`;
              } else if (error.message.includes('Upload response did not contain URL')) {
                errorMessage = 'Upload completed but no URL was returned. Please try again or contact support.';
              } else if (error.message.includes('fetch')) {
                errorMessage = 'Network error. Please check your connection and try again.';
              }

              showToast(errorMessage, 'error');

              // Reset the input and preview
              input.value = '';
              preview.innerHTML = '';
              section.classList.remove('has-image');
            }
          }
        });
      }

      // Function to upload image directly to AWS
      async function uploadImageToAWS(file) {
        const formData = new FormData();
        formData.append('image', file);

        const response = await fetch('https://documents.maxdrv.com/v1/prospect-verification/upload', {
          method: 'POST',
          body: formData,
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error('Upload failed with status:', response.status, 'Response:', errorText);
          throw new Error(`Upload failed: ${response.status} ${response.statusText}. ${errorText}`);
        }

        const result = await response.json();

        if (!result.data.url) {
          console.error('No URL found in response. Full response:', result);
          throw new Error(`Upload response did not contain URL. Response: ${JSON.stringify(result)}`);
        }

        return result.data.url;
      }

      function removeImage(inputId, previewId, sectionId) {
        console.log('removeImage called with:', inputId, previewId, sectionId);

        const input = document.getElementById(inputId);
        const preview = document.getElementById(previewId);
        const section = document.getElementById(sectionId);

        if (input && preview && section) {
          // Clear the input
          input.value = '';
          input.removeAttribute('data-uploaded-url');

          // Clear the preview
          preview.innerHTML = '';

          // Remove the has-image class
          section.classList.remove('has-image');

          // Show success message
          showToast('Image removed successfully', 'success');
        } else {
          console.error('Could not find elements:', { input, preview, section });
          showToast('Error removing image', 'error');
        }
      }

      // Initialize image uploads
      document.addEventListener('DOMContentLoaded', function () {
        setupImageUpload('batteryImageInput', 'batteryImagePreview', 'batteryImageSection');
        setupImageUpload('terminalsImageInput', 'terminalsImagePreview', 'terminalsImageSection');
      });

      function resetForm() {
        // Reset all form inputs
        document.getElementById('qcForm').reset();

        // Reset specific elements that might not be handled by form.reset()
        document.getElementById('batterySerial').value = '';
        document.getElementById('officerName').value = '';
        document.getElementById('testVehiclePlate').value = '';
        document.getElementById('weightConfirmation').value = '';
        document.getElementById('notes').value = '';

        // Reset all checkboxes
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach((checkbox) => {
          checkbox.checked = false;
        });

        // Hide telemetry data section
        document.getElementById('telemetryData').classList.add('d-none');

        // Reset telemetry confirmation checkboxes
        document.getElementById('voltageConfirmed').checked = false;
        document.getElementById('temperatureConfirmed').checked = false;
        document.getElementById('cellVoltageConfirmed').checked = false;
        document.getElementById('differentialVoltageConfirmed').checked = false;
        document.getElementById('socConfirmed').checked = false;
        document.getElementById('cycleCountConfirmed').checked = false;
        document.getElementById('locationConfirmed').checked = false;
        document.getElementById('lastUpdatedConfirmed').checked = false;

        // Reset telemetry values
        document.getElementById('voltageValue').textContent = '0 V';
        document.getElementById('temperatureValue').textContent = '0 Â°C';
        const cellVoltageElement = document.getElementById('cellVoltageValue');
        cellVoltageElement.innerHTML = '--';
        cellVoltageElement.removeAttribute('data-raw-value');
        document.getElementById('differentialVoltageValue').textContent = '0 V';
        document.getElementById('socValue').textContent = '0 %';
        document.getElementById('cycleCountValue').textContent = '0';
        document.getElementById('locationValue').textContent = '0,0';
        const lastUpdatedElement = document.getElementById('lastUpdatedValue');
        lastUpdatedElement.textContent = '--';
        lastUpdatedElement.removeAttribute('data-iso-value');

        // Stop QR scanner if active
        if (scanningActive) {
          stopQRScanner();
        }

        // Reset image uploads
        removeImage('batteryImageInput', 'batteryImagePreview', 'batteryImageSection');
        removeImage('terminalsImageInput', 'terminalsImagePreview', 'terminalsImageSection');

        // Focus on first field for next entry
        document.getElementById('batterySerial').focus();
      }
    </script>
  </body>
</html>
